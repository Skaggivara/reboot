$(document).ready(function(){function p(e,t){var i={api_key:r};$.ajax({url:n+e,dataType:"json",type:"GET",data:i,success:function(e){t&&t(null,e)},error:function(e){t&&t(new Error("Could not find movie detail."))}})}function d(t,n){$.ajax({url:e+"movie/"+t,dataType:"json",type:"GET",success:function(e){n&&n(null,e)},error:function(e){n&&n(new Error("Could not find movie."))}})}function v(t,n){var r={facebook_uid:t.facebook_uid,facebook_token:t.facebook_token,facebook_name:t.facebook_name,title:t.title,description:t.description,year:t.year,poster:t.poster,imdb_id:t.imdb_id,service_id:t.service_id,csrf_token:t.csrf_token};$.ajax({url:e+"movie/"+t.service_id,dataType:"json",type:"POST",data:r,success:function(e){n&&n(null,e)},error:function(e){n&&n(new Error("Could not add movie."))}})}function m(t,n,r,i,s){var o={service_id:t,facebook_uid:n,facebook_token:r,facebook_name:i,csrf_token:$("#csrf_token").val()};$.ajax({url:e+"vote/"+t,dataType:"json",type:"POST",data:o,success:function(e){s&&s(null,e)},error:function(e){s&&s(new Error("You have already voted for that movie."))}})}function g(e,t){$("#loader").show(),d(e.service_id,function(n,r){n?v(e,function(n,r){if(n){t&&t(n),$("#loader").hide();return}m(e.service_id,e.facebook_uid,e.facebook_token,e.facebook_name,function(e,n){if(e){t&&t(e),$("#loader").hide();return}$("#loader").hide(),t&&t(null,"Your vote has been registered!")})}):m(e.service_id,e.facebook_uid,e.facebook_token,e.facebook_name,function(e,n){if(e){t&&t(e),$("#loader").hide();return}$("#loader").hide(),t&&t(null,"Your vote has been registered!")})})}function y(e,n,i){var s={api_key:r,query:C(e)};$.ajax({url:t,dataType:"json",type:"GET",data:s,success:function(e){i&&i(null,e,n)},error:function(e){i&&i(new Error("Could not find any movies."))}})}function b(){var e=$.trim(C($("#search").val())).toLowerCase();e.length>1&&(h+=1,$("#searchform .loader").show(),y(e,h,function(t,n,r){if(t)return;if(n.results.length==0){var o="<li><div class='noresults'>No results found for: '<strong>"+e+"</strong>'</div></li>";$("#searchresult").html(o),$("#searchform .loader").hide()}else if(h===r){$("#searchresult").html(""),$("#searchform .loader").hide();var u=0;$("#searchclosebtn").show();var a="";for(var f in n.results){n.results[f].release_date||(n.results[f].release_date="unknown");if(u<s){var o="<li><a class='movie clearfix' href='#' data-id='"+n.results[f].id+"'><img src='"+i+"w92/"+n.results[f].poster_path+"' width='60' height='84' /><span class='title'>"+n.results[f].title+"</span><span class='desc'>"+n.results[f].release_date.split("-")[0]+"</span></a></li>";a+=o,u++}}$("#searchresult").html(a)}$("#searchresult").show()}))}function w(e,t){t?console.log(e.message):E(e.message)}function E(e){clearInterval(c),$("#message p").html(e),$("#message").show(),c=setTimeout(function(){$("#message").hide()},u)}function S(e){FB.login(function(t){t.authResponse?T(function(n,r){n?e&&e(n):(r.id=t.authResponse.userID,r.accessToken=t.authResponse.accessToken,e&&e(null,r))}):e&&e(new Error("Facebook login failed, please try again."))},{scope:"email,user_photos,publish_stream"})}function x(e){FB.getLoginStatus(function(t){if(t.status==="connected"){var n=t.authResponse.userID,r=t.authResponse.accessToken;T(function(t,i){t?e&&e(new Error("Facebook login failed, please try again.")):e&&e(null,{facebook_token:r,facebook_name:i.name,facebook_uid:n})})}else S(function(t,n){t?e&&e(t):e&&e(null,{facebook_token:n.accessToken,facebook_name:n.name,facebook_uid:n.id})})})}function T(e){FB.api("/me",function(t){t?e&&e(null,{id:t.id,name:t.name}):e&&e(new Error("Could not fetch user info."))})}function N(e,t,n){FB.api("/me/photos","post",{url:t,message:e},function(e){e&&e.post_id?n&&n(null,e.post_id):(console.log(e),n&&n(new Error("Image not uploaded")))})}function C(e){var t=e.replace(/(<([^>]+)>)/ig,"");return t=$.trim(t),t=t.replace(/(\r\n|\n|\r)/gm," "),t}function k(){var e=$.trim(C($("#search").val())).toLowerCase(),t=$("#search").data("current");e!=t&&e.length>1&&($("#search").data("current",e),b())}function L(e){if($("#movie_"+e).length>0){var t=parseInt($("#movie_"+e).data("votes"));$("#movie_"+e).data("votes",t+1),$("#movie_"+e+" .votes").html("("+(t+1)+" votes)")}}function A(){var t={offset:0,limit:11};$.ajax({url:e+"movies",type:"GET",data:t,success:function(e){$("#toplist ol").html(e)},error:function(e){}})}var e="http://rebootmymovie.appspot.com/",t="http://api.themoviedb.org/3/search/movie",n="http://api.themoviedb.org/3/movie/",r="bc5116b9b7b4dceaadcc611420c14950",i="http://cf2.imgobject.com/t/p/",s=4,o=400,u=5e3,a="I just voted for the movie '%' to be rebooted! Vote on the movie you would like to see rebooted at "+e,f=null,l=null,c=null,h=0;$("#searchresult .movie").live("click",function(e){e.preventDefault(),p($(this).data("id"),function(e,t){if(!e){f=t,$("#detail .info h3").html(t.title);var n=t.release_date;n||(n="unknown"),$("#detail .year").html(n.split("-")[0]),$("#detail .imdb a").attr("href","http://www.imdb.com/title/"+t.imdb_id),$("#detail .votes").hide(),$("#detail p").html(t.overview),t.poster_path?$("#detail .poster img").attr("src",i+"w154"+t.poster_path):$("#detail .poster img").attr("src","/static/img/noposter.jpg"),$("#detail").show(),d(t.id,function(e,t){if(!e){var n="vote";t.votes!=1&&(n+="s"),$("#detail .votes").html("("+t.votes+" "+n+"), "),$("#detail .votes").show()}})}}),$("#searchresult").html(""),$("#searchresult").hide(),$("#search").data("current",""),$("#search").val(""),$("#searchclosebtn").hide()}),$("#search").on("focus",function(e){clearInterval(l),l=setInterval(function(){k()},o)}),$("#search").on("blur",function(e){clearInterval(l)}),$("#searchform").on("submit",function(e){e.preventDefault(),clearInterval(l),b()}),$("#toplist .votebtn, #single .votebtn").live("click",function(e){e.preventDefault();if(!$(this).hasClass("loading")){$(this).addClass("loading");var t=$(this).data("id"),n=$(this).data("title"),r=$(this).data("poster");x(function(e,s){if(e){w(e),$("#movie_"+t+" .votebtn").removeClass("loading");return}m(t,s.facebook_uid,s.facebook_token,s.facebook_name,function(e){if(e){w(new Error("You have already voted for that movie.")),$("#movie_"+t+" .votebtn").removeClass("loading");return}E("Your vote has been registered!"),$("#movie_"+t+" .votebtn").hide(),N(a.replace("%",n),i+"w500"+r),L(t)})})}}),$("#detail .votebtn").on("click",function(e){e.preventDefault(),x(function(e,t){if(e){w(e);return}g({facebook_uid:t.facebook_uid,facebook_token:t.facebook_token,facebook_name:t.facebook_name,service_id:f.id,imdb_id:f.imdb_id||"unknown",title:f.title,year:f.release_date,description:f.overview,poster:f.poster_path,csrf_token:$("#csrf_token").val()},function(e,t){if(e){w(e);return}E(t),L(f.id),N(a.replace("%",f.title),i+"w500"+f.poster_path),A()})})}),$("#detail .closebtn").on("click",function(e){e.preventDefault(),$("#detail").hide(),$("#loader").hide()}),$("#searchclosebtn").on("click",function(e){e.preventDefault(),$(this).hide(),$("#search").data("current",""),$("#search").val(""),$("#searchclosebtn").hide(),$("#searchresult").hide(),$("#search").focus()}),$("#message .ok").on("click",function(e){e.preventDefault(),$("#message").hide(),clearInterval(c)})});